name: Create Repository from Issue

on:
  issues:
    types: [opened]

jobs:
  create-repository:
    if: contains(github.event.issue.title, 'gcpg-')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Extract repository name from issue title
        id: extract-repo-name
        run: |
          REPO_NAME="${{ github.event.issue.title }}"
          # ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªåã‚’æŠ½å‡ºï¼ˆç©ºç™½ã‚„æ”¹è¡Œã‚’å‰Šé™¤ï¼‰
          REPO_NAME=$(echo "$REPO_NAME" | tr -d '[:space:]')
          # gcpg-{ç« ç•ªå·}-{ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·} ã®å½¢å¼ã‚’æ¤œè¨¼
          if [[ ! "$REPO_NAME" =~ ^gcpg-[0-9]+-[0-9]+$ ]]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚¤ã‚·ãƒ¥ãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã¯ 'gcpg-{ç« ç•ªå·}-{ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·}' ã®å½¢å¼ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
            echo "ä¾‹: gcpg-6-2, gcpg-1-1"
            exit 1
          fi
          echo "repository_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "âœ… ãƒªãƒã‚¸ãƒˆãƒªå: $REPO_NAME"

      - name: Check if repository already exists
        id: check-repo
        run: |
          REPO_NAME="${{ steps.extract-repo-name.outputs.repository_name }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository_owner }}/$REPO_NAME" || echo "404")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ãƒªãƒã‚¸ãƒˆãƒª $REPO_NAME ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… ãƒªãƒã‚¸ãƒˆãƒª $REPO_NAME ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
          fi

      - name: Create repository from template
        if: steps.check-repo.outputs.exists == 'false'
        run: |
          REPO_NAME="${{ steps.extract-repo-name.outputs.repository_name }}"
          TEMPLATE_REPO="github-cicd-practice-guide-handson"
          
          # ç« ç•ªå·ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã‚’æŠ½å‡º
          CHAPTER=$(echo "$REPO_NAME" | sed -E 's/gcpg-([0-9]+)-[0-9]+/\1/')
          SECTION=$(echo "$REPO_NAME" | sed -E 's/gcpg-[0-9]+-([0-9]+)/\1/')
          
          echo "ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆä¸­: $REPO_NAME"
          echo "   ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: $TEMPLATE_REPO"
          echo "   ç« ç•ªå·: $CHAPTER"
          echo "   ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·: $SECTION"
          
          # PATãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°GITHUB_TOKENã‚’ä½¿ç”¨
          if [ -n "${{ secrets.REPO_CREATION_TOKEN }}" ]; then
            TOKEN="${{ secrets.REPO_CREATION_TOKEN }}"
            echo "ğŸ”‘ Personal Access Token ã‚’ä½¿ç”¨ã—ã¾ã™"
          else
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
            echo "ğŸ”‘ GITHUB_TOKEN ã‚’ä½¿ç”¨ã—ã¾ã™"
          fi
          
          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
          HTTP_CODE=$(curl -s -o /tmp/repo_response.json -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github.baptize-preview+json" \
            -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/${{ github.repository_owner }}/$TEMPLATE_REPO/generate" \
            -d "{
              \"name\": \"$REPO_NAME\",
              \"description\": \"GitHub CI/CD å®Ÿè·µã‚¬ã‚¤ãƒ‰ - ç¬¬${CHAPTER}ç« ã‚»ã‚¯ã‚·ãƒ§ãƒ³${SECTION}ã®ãƒãƒ³ã‚ºã‚ªãƒ³\",
              \"private\": false,
              \"owner\": \"${{ github.repository_owner }}\"
            }")
          
          if [ "$HTTP_CODE" != "201" ]; then
            echo "âŒ ãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_CODE)"
            cat /tmp/repo_response.json
            if [ "$HTTP_CODE" = "404" ]; then
              echo ""
              echo "âš ï¸ ã‚¨ãƒ©ãƒ¼: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª '$TEMPLATE_REPO' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              echo "   è§£æ±ºæ–¹æ³•:"
              echo "   1. '$TEMPLATE_REPO' ã¨ã„ã†åå‰ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„"
              echo "   2. ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Template repository ã§ã€ŒTemplate repositoryã€ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"
              echo "   3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆREADME.md, .gitignore ãªã©ï¼‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"
            elif [ -z "${{ secrets.REPO_CREATION_TOKEN }}" ]; then
              echo ""
              echo "âš ï¸ æ³¨æ„: GITHUB_TOKENã§ã¯ä»–ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™"
              echo "   è§£æ±ºæ–¹æ³•: Personal Access Token (PAT) ã‚’ secrets.REPO_CREATION_TOKEN ã«è¨­å®šã—ã¦ãã ã•ã„"
              echo "   PATã®ä½œæˆæ–¹æ³•: https://github.com/settings/tokens"
              echo "   å¿…è¦ãªæ¨©é™: repo (ã™ã¹ã¦ã®ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹)"
            fi
            exit 1
          fi
          
          echo "âœ… ãƒªãƒã‚¸ãƒˆãƒª $REPO_NAME ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: Set repository topics
        if: steps.check-repo.outputs.exists == 'false'
        run: |
          REPO_NAME="${{ steps.extract-repo-name.outputs.repository_name }}"
          
          echo "ğŸ·ï¸ ãƒˆãƒ”ãƒƒã‚¯ã‚¹ã‚’è¨­å®šä¸­..."
          
          # PATãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°GITHUB_TOKENã‚’ä½¿ç”¨
          if [ -n "${{ secrets.REPO_CREATION_TOKEN }}" ]; then
            TOKEN="${{ secrets.REPO_CREATION_TOKEN }}"
          else
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PUT \
            -H "Accept: application/vnd.github.mercy-preview+json" \
            -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/${{ github.repository_owner }}/$REPO_NAME/topics" \
            -d '{
              "names": [
                "github-cicd-practice-guide",
                "handson",
                "cicd",
                "github-actions"
              ]
            }')
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ãƒˆãƒ”ãƒƒã‚¯ã‚¹ã‚’è¨­å®šã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ ãƒˆãƒ”ãƒƒã‚¯ã‚¹ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP $HTTP_CODEï¼‰ï¼ˆãƒªãƒã‚¸ãƒˆãƒªã¯ä½œæˆã•ã‚Œã¦ã„ã¾ã™ï¼‰"
          fi

      - name: Update README with chapter and section numbers
        if: steps.check-repo.outputs.exists == 'false'
        run: |
          REPO_NAME="${{ steps.extract-repo-name.outputs.repository_name }}"
          CHAPTER=$(echo "$REPO_NAME" | sed -E 's/gcpg-([0-9]+)-[0-9]+/\1/')
          SECTION=$(echo "$REPO_NAME" | sed -E 's/gcpg-[0-9]+-([0-9]+)/\1/')
          
          echo "ğŸ“„ READMEã‚’æ›´æ–°ä¸­..."
          echo "   ç« ç•ªå·: $CHAPTER"
          echo "   ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·: $SECTION"
          
          # PATãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°GITHUB_TOKENã‚’ä½¿ç”¨
          if [ -n "${{ secrets.REPO_CREATION_TOKEN }}" ]; then
            TOKEN="${{ secrets.REPO_CREATION_TOKEN }}"
          else
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi
          
          # ãƒªãƒã‚¸ãƒˆãƒªã®åˆæœŸåŒ–ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§30ç§’ï¼‰
          echo "â³ ãƒªãƒã‚¸ãƒˆãƒªã®åˆæœŸåŒ–ã‚’å¾…æ©Ÿä¸­..."
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/${{ github.repository_owner }}/$REPO_NAME/contents/README.md" | grep -q "200"; then
              echo "âœ… ãƒªãƒã‚¸ãƒˆãƒªãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ãƒªãƒã‚¸ãƒˆãƒªã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™"
            else
              sleep 1
            fi
          done
          
          # ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone "https://$TOKEN@github.com/${{ github.repository_owner }}/$REPO_NAME.git" repo
          cd repo
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ç¢ºèª
          DEFAULT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "main")
          
          # READMEã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
          if [ -f README.md ]; then
            # macOSã¨Linuxã®äº’æ›æ€§ã‚’è€ƒæ…®
            if [[ "$OSTYPE" == "darwin"* ]]; then
              sed -i '' "s/{CHAPTER}/$CHAPTER/g" README.md
              sed -i '' "s/{SECTION}/$SECTION/g" README.md
            else
              sed -i "s/{CHAPTER}/$CHAPTER/g" README.md
              sed -i "s/{SECTION}/$SECTION/g" README.md
            fi
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "docs: READMEã®ç« ç•ªå·ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã‚’æ›´æ–°"
            git push origin "$DEFAULT_BRANCH"
            
            echo "âœ… READMEã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ README.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
          fi

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-repo-name.outputs.repository_name }}';
            const exists = '${{ steps.check-repo.outputs.exists }}' === 'true';
            
            if (exists) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âš ï¸ ãƒªãƒã‚¸ãƒˆãƒª \`${repoName}\` ã¯æ—¢ã«å­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚`
              });
            } else {
              const repoUrl = `https://github.com/${{ github.repository_owner }}/${repoName}`;
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âœ… ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸï¼\n\n- ãƒªãƒã‚¸ãƒˆãƒª: [${repoName}](${repoUrl})\n- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: \`github-cicd-practice-guide-handson\`\n- ãƒˆãƒ”ãƒƒã‚¯ã‚¹: \`github-cicd-practice-guide\`, \`handson\`, \`cicd\`, \`github-actions\`\n\nãƒªãƒã‚¸ãƒˆãƒªã¯ public ã§ä½œæˆã•ã‚Œã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã¾ã™ã€‚`
              });
            }

